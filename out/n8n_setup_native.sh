#!/usr/bin/env bash
set -euo pipefail
# Generated by cyberzard n8n-setup
# Mode: native
# Domain: n8n.example.com
# Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
# Edit carefully; re-run generator for changes.


DOMAIN="example.com"
SUBDOMAIN="n8n"
N8N_PORT=5678
DB_PASS='XtMeK9NhAQDDDw6RHa9rF7w27i1Okx8nfJeAW_bWPmU'
N8N_DIR="$HOME/n8n-data"
POSTGRES_DIR="$HOME/postgres-data"
NETWORK="n8n-net"

mkdir -p "$N8N_DIR" "$POSTGRES_DIR"
docker network create "$NETWORK" >/dev/null 2>&1 || true

echo "[+] Starting PostgreSQL container"
docker run -d     --name n8n-postgres     --network "$NETWORK"     -e POSTGRES_USER=n8n     -e POSTGRES_PASSWORD=$DB_PASS     -e POSTGRES_DB=n8n     -v "$POSTGRES_DIR:/var/lib/postgresql/data"     postgres:16

echo "[+] Starting n8n container"
docker run -d     --name n8n     --network "$NETWORK"     -p 127.0.0.1:$N8N_PORT:5678     -v "$N8N_DIR:/home/node/.n8n"     -e DB_TYPE=postgresdb     -e DB_POSTGRESDB_HOST=n8n-postgres     -e DB_POSTGRESDB_PORT=5432     -e DB_POSTGRESDB_DATABASE=n8n     -e DB_POSTGRESDB_USER=n8n     -e DB_POSTGRESDB_PASSWORD=$DB_PASS     -e N8N_HOST=$SUBDOMAIN.$DOMAIN     -e N8N_PORT=5678     -e N8N_PROTOCOL=https     -e WEBHOOK_URL=https://$SUBDOMAIN.$DOMAIN/     -e NODE_ENV=production     -e GENERIC_TIMEZONE=UTC \
       n8nio/n8n:latest

echo "[+] Ensure OpenLiteSpeed reverse proxy configuration present (manual append if needed)"
echo "[i] Issue SSL via CyberPanel CLI"
cyberpanel issueSSL --domain "$SUBDOMAIN.$DOMAIN" || true
echo "[i] Restarting OpenLiteSpeed"
sh /usr/local/lsws/bin/lswsctrl restart || true

echo "[âœ“] n8n native setup complete: https://$SUBDOMAIN.$DOMAIN (store DB_PASS securely)"
